<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Duty & Ad Manager</title>

  <!-- Stylesheets -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#3F51B5"/> <!-- एड्रेस बार का रंग (इंडिगो) -->
  <link rel="manifest" href="/manifest.json"> <!-- मैनिफेस्ट फाइल का लिंक -->
  <meta name="mobile-web-app-capable" content="yes"> <!-- पुराने एंड्रॉइड क्रोम के लिए -->
  <meta name="apple-mobile-web-app-capable" content="yes"> <!-- iOS के लिए (वैकल्पिक) -->
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> <!-- iOS के लिए (वैकल्पिक) -->
  <meta name="apple-mobile-web-app-title" content="Duty Ad Mgr"> <!-- iOS के लिए (वैकल्पिक) -->
  <!-- <link rel="apple-touch-icon" href="/icons/icon-192x192.png"> --> <!-- iOS आइकन (वैकल्पिक, आइकन बनाएं) -->

  <style>
    /* Vibrant & Animated Theme */
    :root {
      --primary-color: #3F51B5; /* Indigo */
      --primary-dark-color: #303F9F;
      --accent-color: #FF4081; /* Pink */
      --accent-gradient: linear-gradient(135deg, #ff9966, #ff5e62); /* Orange/Coral Gradient for Ad Post */
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%); /* Purple/Blue Gradient for Header/Buttons */
      --background-color: #f0f2f5; /* Very light grey */
      --surface-color: #ffffff;
      --on-primary-color: #ffffff;
      --on-surface-color: #333;
      --on-surface-medium-color: #666;
      --on-surface-disabled-color: #bbb;
      --error-color: #e74c3c; /* Bright Red */
      --error-gradient: linear-gradient(135deg, #e74c3c, #c0392b); /* Red gradient for Delete */
      --success-color: #2ecc71; /* Bright Green */
      --success-gradient: linear-gradient(135deg, #2ecc71, #27ae60); /* Green gradient for Download */
      --info-color: #3498db; /* Bright Blue */
      --info-gradient: linear-gradient(135deg, #3498db, #2980b9); /* Blue gradient for Summary Btn */
      --timer-color: #7f8c8d; /* Grey */

      --card-shadow: 0 4px 8px rgba(0,0,0,0.08); /* Softer shadow */
      --button-shadow: 0 2px 5px rgba(0,0,0,0.15);
      --header-shadow: 0 3px 6px rgba(0,0,0,0.16);
      --border-color-light: #e0e0e0;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { height: 100%; }
    body {
      font-family: 'Roboto', sans-serif;
      background: var(--background-color);
      color: var(--on-surface-color);
      padding: 0;
      margin: 0;
      line-height: 1.5;
      display: flex;
      flex-direction: column;
      min-height: 100%;
      overflow-x: hidden;
    }
    .status-bar-placeholder { height: 24px; background: var(--primary-gradient); flex-shrink: 0; }
    .header {
        background: var(--primary-gradient);
        color: var(--on-primary-color);
        padding: 14px 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--header-shadow);
        flex-shrink: 0;
        position: sticky;
        top: 24px;
        z-index: 100;
        animation: slideDown 0.5s ease-out;
    }
    .header .logo { font-size: 1.2rem; font-weight: 500; display: flex; align-items: center; gap: 8px; margin: 0; }
    .header .logo .material-icons { font-size: 1.4rem; }

    .tab-buttons {
        display: flex;
        background-color: var(--surface-color);
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        flex-shrink: 0;
        position: sticky;
        top: calc(24px + 52px); /* Adjusted for header height */
        z-index: 99;
    }
    .tab-button {
        flex: 1; padding: 14px 16px; color: var(--on-surface-medium-color); border: none; background: none; cursor: pointer; transition: color 0.2s ease, border-color 0.2s ease; font-weight: 500; font-size: 0.9rem; text-transform: uppercase; position: relative; text-align: center; border-bottom: 3px solid transparent;
    }
    .tab-button:hover { color: var(--primary-color); }
    .tab-button.active { color: var(--primary-color); font-weight: 700; border-bottom-color: var(--primary-color); }
    .tab-button:disabled { opacity: 0.5; cursor: not-allowed; color: var(--on-surface-disabled-color); border-bottom-color: transparent; }

    .container { max-width: 100%; margin: 0 auto; padding: 20px; flex-grow: 1; }
    .tab-content { display: none; animation: fadeIn 0.4s ease-out; }
    .tab-content.active { display: block; }

    /* Form Styles */
    h3 { text-align: left; margin-bottom: 24px; font-size: 1.15rem; font-weight: 700; color: var(--primary-dark-color); padding-bottom: 8px; border-bottom: 1px solid var(--border-color-light); }
    form { gap: 20px; display: flex; flex-direction: column;}
    .form-field { position: relative; padding-top: 12px; }
    /* Label styles for floating effect */
    .form-field label {
        position: absolute;
        top: 14px; /* Start position inside the input area */
        left: 0;
        font-weight: 400;
        color: var(--on-surface-medium-color);
        font-size: 1rem;
        transition: all 0.2s ease-out;
        pointer-events: none;
        background-color: transparent; /* No background needed now */
        padding: 0 5px; /* Add slight padding if needed for background override */
    }
    /* Input styles */
    .form-field input, .form-field select, .form-field textarea {
        width: 100%;
        padding: 10px 0 6px 0; /* Adjust padding-top for label space */
        font-size: 1rem;
        border: none;
        border-bottom: 1px solid var(--border-color-light);
        border-radius: 0;
        background: transparent;
        color: var(--on-surface-color);
        transition: border-color 0.3s ease;
        font-family: 'Roboto', sans-serif;
        position: relative;
        z-index: 1; /* Ensure input is above label bg if it had one */
    }
    /* Label transition on focus or when input has value */
    .form-field input:focus + label, .form-field input:not(:placeholder-shown) + label,
    .form-field textarea:focus + label, .form-field textarea:not(:placeholder-shown) + label,
    .form-field select:focus + label, .form-field select:valid + label {
        top: -2px; /* Move label up */
        font-size: 0.75rem;
        color: var(--primary-color);
        z-index: 2; /* Ensure label is above input border */
        /* Dynamically set background in JS/resetForm for different contexts */
    }
    /* Focus styles for input */
    .form-field input:focus, .form-field select:focus, .form-field textarea:focus {
        outline: none;
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 5px; /* Adjust padding to keep height consistent */
    }
    /* Select dropdown arrow */
    .form-field select {
        appearance: none;
        -webkit-appearance: none;
        background-image: url('data:image/svg+xml;utf8,<svg fill="%23546E7A" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
        background-repeat: no-repeat;
        background-position: right 0 center;
        background-size: 1.5em;
        padding-right: 30px;
        cursor: pointer;
    }
    select:required:invalid { color: var(--on-surface-medium-color); } option[value=""][disabled] { display: none; } option { color: var(--on-surface-color); background-color: var(--surface-color); }
    form hr { border: none; border-top: 1px solid var(--border-color-light); margin: 24px 0; }

    /* Button Styles */
    .uniform-btn { padding: 10px 24px; border: none; border-radius: 25px; color: var(--on-primary-color); cursor: pointer; font-weight: 500; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.8px; transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease; box-shadow: var(--button-shadow); background: var(--primary-gradient); align-self: flex-end; display: inline-flex; align-items: center; gap: 6px; animation: pulse 2.5s infinite ease-in-out; }
    @keyframes pulse { 0%, 100% { transform: scale(1); box-shadow: var(--button-shadow); } 50% { transform: scale(1.03); box-shadow: 0 4px 10px rgba(0,0,0,0.2); } }
    .uniform-btn:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 4px 10px rgba(0,0,0,0.25); animation: none; filter: brightness(1.1); }
    .uniform-btn:disabled { background: #B0BEC5 !important; color: #78909C !important; box-shadow: none; cursor: not-allowed; animation: none; transform: none; filter: none; opacity: 0.7;} /* Added !important and opacity */
    #jobAdForm button[type="submit"], #postNewAdBtn { background: var(--accent-gradient) !important; }
    .delete-month-btn { background: var(--error-gradient) !important; }
    .download-pdf-btn { background: var(--success-gradient) !important; }
    .summary-btn { background: var(--info-gradient) !important; align-self: flex-start; }
    .edit-btn { background: transparent !important; color: var(--primary-color) !important; box-shadow: none !important; padding: 6px 8px !important; font-size: 0.8rem !important; min-width: auto !important; text-transform: uppercase; font-weight: 700; animation: none; }
    .edit-btn:hover { background-color: rgba(63, 81, 181, 0.08) !important; transform: none; filter: none; }
    .edit-btn:disabled { color: var(--on-surface-disabled-color) !important; background: transparent !important; cursor: not-allowed; opacity: 0.5; } /* Disabled style for edit */
    .modal-actions button[onclick*="close"] { background: transparent !important; color: var(--primary-color) !important; box-shadow: none !important; font-weight: 700; animation: none;}
    .modal-actions button[onclick*="close"]:hover { background-color: rgba(63, 81, 181, 0.08) !important; }
    #editDutyForm + .modal-actions button[type="submit"] { background: var(--primary-gradient) !important; }
    #jobAdForm + .modal-actions button[type="submit"] { background: var(--accent-gradient) !important; }


    /* Table Styles */
    table { width: 100%; border-collapse: collapse; margin-top: 16px; background: var(--surface-color); border-radius: 8px; overflow: hidden; box-shadow: var(--card-shadow); border: none; }
    table th, table td { padding: 14px 16px; text-align: left; border-bottom: 1px solid var(--border-color-light); vertical-align: middle; font-size: 0.9rem; }
    table th { background: #f8f9fa; font-weight: 500; color: var(--on-surface-medium-color); text-transform: none; font-size: 0.85rem; }
    table tr:last-child td { border-bottom: none; }
    table td { color: var(--on-surface-color); }
    table tbody tr { animation: fadeInTableRow 0.5s ease-out backwards; }
    @keyframes fadeInTableRow { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .shutty-row { background-color: #ffebee !important; color: var(--error-color) !important; font-weight: 500; }
    .blue-text { color: var(--info-color) !important; font-weight: 500; }
    #view-data .action-buttons { display: flex; justify-content: space-around; gap: 16px; margin-top: 24px; padding: 0; background: none; border-radius: 0; box-shadow: none; }
    #view-data .action-buttons .uniform-btn { flex: 1; text-align: center; align-self: stretch; animation: none; }

    /* Summary Card */
    .summary { margin-top: 24px; padding: 20px; background: var(--surface-color); border-radius: 8px; box-shadow: var(--card-shadow); border: none; display: none; flex-direction: column; gap: 14px; }
    .summary h4 { text-align: left; color: var(--primary-dark-color); margin-bottom: 16px; font-size: 1.05rem; font-weight: 700; border-bottom: none; padding-bottom: 0; }
    .summary div { display: flex; justify-content: space-between; font-size: 0.9rem; border-bottom: 1px dotted var(--border-color-light); padding-bottom: 10px; }
    .summary div:last-child { border-bottom: none; padding-bottom: 0; }
    .summary span:first-child { font-weight: 400; color: var(--on-surface-medium-color); }
    .summary span:last-child { font-weight: 500; color: var(--on-surface-color); }
    .summary div:last-of-type { border-top: 1px solid var(--border-color-light); margin-top: 10px; padding-top: 10px; font-weight: bold; font-size: 1rem;}
    .summary div:last-of-type span:last-child { color: var(--primary-color); font-weight: 700;}
    .summary-btn { align-self: flex-start; margin: 16px 0 !important; animation: none; }

    /* Modal Styles */
    .modal { display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); animation: fadeIn 0.3s ease-out; }
    .modal-content-wrapper { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.95); width: 90%; max-width: 500px; max-height: 85vh; display: flex; flex-direction: column; opacity: 0; animation: scaleUp 0.3s 0.1s ease-out forwards; }
    .modal-content { background-color: var(--surface-color); border: none; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); overflow: hidden; display: flex; flex-direction: column; flex-grow: 1; }
    .modal-header { background: var(--primary-gradient); color: var(--on-primary-color); padding: 16px 24px; position: relative; flex-shrink: 0; }
    .modal-header h3 { color: var(--on-primary-color); border-bottom: none; margin: 0; font-size: 1.2rem; }
    .close-btn { color: rgba(255, 255, 255, 0.7); position: absolute; top: 14px; right: 16px; font-size: 24px; transition: color 0.2s ease; background: none; border: none; cursor: pointer; padding: 0; line-height: 1; }
    .close-btn:hover, .close-btn:focus { color: var(--on-primary-color); }
    .modal-body { padding: 24px; overflow-y: auto; flex-grow: 1; }
    .modal-actions { padding: 16px 24px; background-color: #f9f9f9; border-top: 1px solid var(--border-color-light); display: flex; justify-content: flex-end; gap: 10px; flex-shrink: 0; }
    @keyframes scaleUp { from { transform: translate(-50%, -50%) scale(0.95); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }

    /* Month Selector */
    .month-selector-container { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; background: var(--surface-color); padding: 12px 16px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .month-selector-container label { font-weight: 500; color: var(--primary-color); flex-shrink: 0; margin-right: 5px; }
    #monthSelector {
        flex-grow: 1; padding: 8px 0; font-size: 1rem; border: none; border-bottom: 1px solid var(--border-color-light); border-radius: 0; background: transparent; color: var(--on-surface-color);
        appearance: none; -webkit-appearance: none; background-image: url('data:image/svg+xml;utf8,<svg fill="%23546E7A" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>'); background-repeat: no-repeat; background-position: right 0 center; background-size: 1.5em; padding-right: 30px; cursor: pointer; margin-left: 5px;
    }
    #monthSelector:focus { outline: none; border-bottom: 2px solid var(--primary-color); padding-bottom: 7px; }
    #monthSelector:disabled { opacity: 0.5; color: var(--on-surface-disabled-color); border-bottom-color: var(--on-surface-disabled-color); background-color: #eee; cursor: not-allowed;} /* Added visual disabled state */

    /* Job Ad Styles */
     #jobAdsHeader { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 16px; margin-bottom: 16px; padding-bottom: 0; border-bottom: none; }
     #jobAdsHeader h3 { flex-basis: 100%; text-align: left; border-bottom: 1px solid var(--border-color-light); padding-bottom: 8px;}
     #jobAdsHeader .form-field { flex-grow: 1; margin-bottom: 0; padding-top: 0; min-width: 180px; }
     #jobAdsHeader .form-field label { top: 10px; }
     #jobAdsHeader .form-field input:focus + label,
     #jobAdsHeader .form-field input:not(:placeholder-shown) + label { top: -10px; }
     #jobAdsHeader .form-field input#citySearchInput { padding: 10px 0 6px 0; }
     #jobAdsHeader .form-field input:disabled { background-color: #eee; cursor: not-allowed; border-bottom-color: var(--on-surface-disabled-color); } /* Disable search input visually */

     #postNewAdBtn { align-self: center; margin-top: 12px; animation: none; flex-shrink: 0; }

     #jobAdsList { margin-top: 16px; display: grid; gap: 18px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
     .job-ad-card { background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%); border: none; border-left: 5px solid var(--primary-color); padding: 18px 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); position: relative; transition: box-shadow 0.3s ease, transform 0.3s ease; animation: slideUp 0.5s ease-out backwards; display: flex; flex-direction: column; }
     .job-ad-card:hover { box-shadow: 0 8px 20px rgba(63, 81, 181, 0.15); transform: translateY(-4px); border-left-color: var(--accent-color); }
     .job-ad-card .ad-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; border-bottom: 1px dashed var(--border-color-light); padding-bottom: 10px; }
     .job-ad-card h4 { color: var(--primary-dark-color); margin: 0; font-size: 1.1rem; font-weight: 700; line-height: 1.3; flex-grow: 1; padding-right: 10px; }
     .job-ad-card .ad-city { display: inline-flex; align-items: center; gap: 4px; font-size: 0.85rem; color: var(--on-surface-medium-color); background-color: #e8eaf6; padding: 3px 8px; border-radius: 12px; white-space: nowrap; flex-shrink: 0; }
     .job-ad-card .ad-city .material-icons { font-size: 1rem; }
     .job-ad-card .ad-description { margin-bottom: 15px; font-size: 0.9rem; color: var(--on-surface-color); line-height: 1.6; flex-grow: 1; }
     .job-ad-card .ad-contact { display: flex; align-items: center; gap: 6px; font-size: 0.85rem; color: var(--info-color); font-weight: 500; margin-top: auto; padding-top: 10px; border-top: 1px dashed var(--border-color-light); }
     .job-ad-card .ad-contact .material-icons { font-size: 1rem; }
     .ad-timer { position: absolute; bottom: 10px; right: 16px; font-size: 0.75rem; color: var(--timer-color); background-color: rgba(240, 242, 245, 0.8); padding: 2px 6px; border-radius: 4px; }
     .no-ads-message, .no-data-message { /* Combined class */
        text-align: center;
        color: var(--on-surface-medium-color);
        padding: 32px;
        font-size: 0.95rem;
     }
     .offline-message { /* New style for offline message */
        text-align: center;
        color: var(--error-color);
        background-color: #ffebee;
        padding: 24px 16px; /* Adjusted padding */
        font-size: 0.95rem; /* Adjusted font size */
        font-weight: 500;
        border: 1px solid var(--error-color);
        border-radius: 8px;
        margin-top: 16px;
        line-height: 1.4;
     }


    /* Floating Action Button (FAB) */
    .fab { position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px; border-radius: 50%; background: var(--accent-gradient); color: var(--on-primary-color); border: none; box-shadow: 0 6px 10px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 999; transition: transform 0.2s ease-out, box-shadow 0.2s ease-out, background 0.2s ease, opacity 0.2s ease; animation: zoomIn 0.4s 0.5s ease-out backwards; } /* Added background and opacity transition */
    .fab:hover { transform: scale(1.05) rotate(15deg); box-shadow: 0 8px 15px rgba(0,0,0,0.25); }
    .fab .material-icons { font-size: 24px; }
    .fab:disabled { background: #B0BEC5 !important; cursor: not-allowed; animation: none; transform: none; box-shadow: none; opacity: 0.7; } /* Disabled FAB */


    /* Full Screen Add Duty Screen */
    .fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--background-color); z-index: 1001; display: none; flex-direction: column; overflow: hidden; animation: slideUpFullScreen 0.4s ease-out; }
     .fullscreen-header { background: var(--primary-gradient); color: var(--on-primary-color); padding: 14px 16px; display: flex; align-items: center; justify-content: space-between; box-shadow: var(--header-shadow); flex-shrink: 0; }
     .fullscreen-header h3 { color: var(--on-primary-color); margin: 0; font-size: 1.2rem; border: none; padding: 0; }
     .fullscreen-header .close-fullscreen-btn { background: none; border: none; color: var(--on-primary-color); font-size: 24px; cursor: pointer; padding: 5px; line-height: 1; }
     .fullscreen-content { padding: 20px; flex-grow: 1; overflow-y: auto; }
     .fullscreen-content form { margin-bottom: 20px; }
     #rateForm button[type="submit"], #dutyForm button[type="submit"] { align-self: flex-end; background: var(--primary-gradient) !important; }


    /* Animations */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes slideUpFullScreen { from { transform: translateY(100%); } to { transform: translateY(0); } }
    @keyframes zoomIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    /* Media Queries */
    @media (max-width: 600px) {
         .header { top: 0; } .status-bar-placeholder { display: none; } .tab-buttons { top: 52px; }
         .container { padding: 16px; }
         h3 { font-size: 1.1rem; }
         /* Default buttons to full width */
         .uniform-btn { width: 100%; text-align: center; justify-content: center; }
         /* Override for specific buttons */
         #postNewAdBtn, .edit-btn, .modal-actions button { width: auto; justify-content: center; /* Keep centering */ }

         #view-data .action-buttons { flex-direction: column; padding: 0; background: none; box-shadow: none; gap: 12px; }
         #view-data .action-buttons .uniform-btn { width: 100%; } /* These should remain full width */
         .summary-btn { width: 100%; align-self: stretch; }
         .month-selector-container { flex-direction: column; align-items: stretch; padding: 10px 12px; }
         .month-selector-container label { margin-bottom: 5px; text-align: left; width: 100%; margin-right: 0; }
         #monthSelector { margin-left: 0; }
         #jobAdsHeader { gap: 12px; align-items: flex-end; /* Align search and button better */ }
         #jobAdsHeader h3 { flex-basis: 100%; text-align: center; }
         #jobAdsHeader .form-field { width: auto; flex-grow: 1; min-width: 150px; /* Give search more space */}
         #postNewAdBtn { min-width: 90px; margin-top: 0; padding: 10px 16px; margin-bottom: 0; /* Align with search bottom */ }
         .modal-content-wrapper { width: calc(100% - 32px); max-height: 90vh; }
         .modal-body { padding: 20px; }
         .modal-actions { padding: 12px 20px; flex-direction: column-reverse; gap: 8px; }
         .modal-actions button { width: 100%; } /* Modal buttons full width */
         .fab { bottom: 16px; right: 16px; width: 50px; height: 50px; }
         .fab .material-icons { font-size: 22px; }
         .fullscreen-content { padding: 16px; }
         .fullscreen-header { padding: 12px 16px; }
         .fullscreen-header h3 { font-size: 1.1rem; }
         #rateForm button[type="submit"], #dutyForm button[type="submit"] { width: 100%; align-self: stretch; }
         #jobAdsList { grid-template-columns: 1fr; }
         .edit-btn { padding: 8px 10px !important; } /* Slightly larger tap target */
    }
  </style>
</head>
<body>
<script type="text/javascript">
	atOptions = {
		'key' : 'ac382d61ec66314c6d8c6c0179aaedfc',
		'format' : 'iframe',
		'height' : 50,
		'width' : 320,
		'params' : {}
	};
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/ac382d61ec66314c6d8c6c0179aaedfc/invoke.js"></script>
  
  <!-- HTML Structure -->
  <div class="status-bar-placeholder"></div>
  <div class="header">
      <div class="logo"><i class="material-icons">event_note</i> Duty & Ad Manager</div>
  </div>
  <div class="tab-buttons">
    <!-- Tab buttons will be enabled/disabled via JS -->
    <button class="tab-button" onclick="switchTab('view-data')" id="viewDataTab">View Duty</button>
    <button class="tab-button" onclick="switchTab('job-ads')">Job Ads</button>
  </div>

  <div class="container">
    <div id="view-data" class="tab-content">
        <!-- Duty Log Content (Will show offline message if needed) -->
        <!-- Offline message will be inserted here by JS if needed -->
        <h3>Duty Log</h3>
        <div class="month-selector-container">
            <label for="monthSelector">Month:</label>
            <select id="monthSelector"></select>
        </div>
        <table id="monthlyDataTable">
            <thead>
                <tr><th>Date</th><th>Shift</th><th>Hours</th><th>OT</th><th>Actions</th></tr>
            </thead>
            <tbody><!-- Content or offline message here --></tbody>
        </table>
        <button class="uniform-btn summary-btn" onclick="toggleSummary()" id="summaryToggleBtn" disabled>
            <i class="material-icons">summarize</i><span>Summary</span>
        </button>
        <div class="summary summary-section" id="summarySection">
             <h4>Summary (<span id="summaryMonthLabel"></span>)</h4>
             <div><span>Total Hours:</span><span id="totalHoursWorked">0.00 hrs</span></div>
             <div><span>Total OT Hours:</span><span id="totalOTHrs">0.00 hrs</span></div>
             <div><span>Reg. Rate:</span><span id="summaryRegularRate">₹0.00/hr</span></div>
             <div><span>OT Rate:</span><span id="summaryOtRate">₹0.00/hr</span></div>
             <div><span>Reg. Pay:</span><span id="totalRegularPayment">₹0.00</span></div>
             <div><span>OT Pay:</span><span id="totalOTPayment">₹0.00</span></div>
             <div><span>Grand Total:</span><span id="totalPayment">₹0.00</span></div>
        </div>
        <div class="action-buttons">
            <button class="uniform-btn delete-month-btn" onclick="deleteCurrentMonthData()" id="deleteMonthBtn" disabled>
                <i class="material-icons">delete_sweep</i><span>Delete Month</span>
            </button>
            <button class="uniform-btn download-pdf-btn" onclick="downloadMonthPDF()" id="downloadPdfBtn" disabled>
                <i class="material-icons">picture_as_pdf</i><span>PDF</span>
            </button>
        </div>
    </div>

    <div id="job-ads" class="tab-content">
       <!-- Job Ads Content (Will show offline message if needed) -->
       <!-- Offline message will be inserted here by JS if needed -->
       <div id="jobAdsHeader">
           <h3>Available Job Ads</h3>
           <div class="form-field">
               <input type="search" id="citySearchInput" placeholder=" ">
               <label for="citySearchInput">Search by City</label>
           </div>
           <button id="postNewAdBtn" class="uniform-btn" onclick="openAddAdModal()">
               <i class="material-icons">add</i><span>Post Ad</span>
           </button>
       </div>
       <div id="jobAdsList">
           <!-- Content or offline message here -->
           <p class="no-ads-message">Loading...</p>
       </div>
    </div>
  </div>

  <button class="fab" id="fabButton" onclick="openAddDutyScreen()" title="Add New Duty">
      <i class="material-icons">add</i>
  </button>

  <!-- Fullscreen Add/Update Duty Screen -->
  <div id="addDutyScreen" class="fullscreen-overlay">
      <div class="fullscreen-header">
          <h3>Add / Update Duty Info</h3>
          <button class="close-fullscreen-btn" onclick="closeAddDutyScreen()">
              <i class="material-icons">close</i>
          </button>
      </div>
      <div class="fullscreen-content">
           <form id="rateForm">
               <h4>Payment Rates</h4>
               <div class="form-field">
                   <input type="number" step="any" min="0" id="regularRate" placeholder=" " required>
                   <label for="regularRate">Regular Rate (₹/hour)</label>
               </div>
               <div class="form-field">
                   <input type="number" step="any" min="0" id="otRate" placeholder=" " required>
                   <label for="otRate">OT Rate (₹/hour)</label>
               </div>
               <button type="submit" class="uniform-btn">
                   <i class="material-icons">save</i><span>Save Rates</span>
                </button>
           </form>
           <hr>
           <form id="dutyForm">
               <h4>New Duty Entry</h4>
               <div class="form-field">
                   <input type="date" id="date" placeholder=" " required>
                   <label for="date">Date</label>
               </div>
               <div class="form-field">
                   <select id="shift" required>
                       <option value="" disabled selected></option>
                       <option value="Fast">Fast</option>
                       <option value="Second">Second</option>
                       <option value="Night">Night</option>
                       <option value="Off Day">Off Day</option>
                   </select>
                   <label for="shift">Shift</label>
               </div>
               <div class="form-field">
                   <input type="number" step="any" min="0" id="hours" placeholder=" ">
                   <label for="hours">Hours Worked</label>
               </div>
               <div class="form-field">
                   <input type="number" step="any" min="0" id="otHours" placeholder=" ">
                   <label for="otHours">OT Hours</label>
               </div>
               <button type="submit" class="uniform-btn">
                   <i class="material-icons">add_circle_outline</i><span>Add Duty</span>
                </button>
           </form>
      </div>
  </div>

  <!-- Edit Duty Modal -->
  <div id="editDutyModal" class="modal">
      <div class="modal-content-wrapper">
          <div class="modal-content">
              <div class="modal-header">
                  <h3>Edit Duty Entry</h3>
                  <button class="close-btn" onclick="closeEditModal()">&times;</button>
              </div>
              <div class="modal-body">
                  <form id="editDutyForm">
                      <input type="hidden" id="editDutyId">
                      <div class="form-field">
                          <input type="date" id="editDate" required placeholder=" ">
                          <label for="editDate">Date</label>
                      </div>
                      <div class="form-field">
                          <select id="editShift" required>
                              <option value="Fast">Fast</option>
                              <option value="Second">Second</option>
                              <option value="Night">Night</option>
                              <option value="Off Day">Off Day</option>
                          </select>
                          <label for="editShift">Shift</label>
                      </div>
                      <div class="form-field">
                          <input type="number" step="any" min="0" id="editHours" placeholder=" ">
                          <label for="editHours">Hours</label>
                      </div>
                      <div class="form-field">
                          <input type="number" step="any" min="0" id="editOtHours" placeholder=" ">
                          <label for="editOtHours">OT Hours</label>
                      </div>
                   </form>
              </div>
              <div class="modal-actions">
                  <button type="button" class="uniform-btn" onclick="closeEditModal()">Cancel</button>
                  <button type="submit" form="editDutyForm" class="uniform-btn">Save Changes</button>
              </div>
          </div>
       </div>
  </div>

  <!-- Add Job Ad Modal -->
  <div id="addJobAdModal" class="modal">
     <div class="modal-content-wrapper">
         <div class="modal-content">
             <div class="modal-header">
                 <h3>Post New Job Ad</h3>
                 <button class="close-btn" onclick="closeAddAdModal()">&times;</button>
             </div>
             <div class="modal-body">
                 <form id="jobAdForm">
                     <div class="form-field">
                         <input type="text" id="adTitle" required placeholder=" ">
                         <label for="adTitle">Job Title</label>
                     </div>
                     <div class="form-field">
                         <input type="text" id="adCity" required placeholder=" ">
                         <label for="adCity">City</label>
                     </div>
                     <div class="form-field">
                         <textarea id="adDescription" required placeholder=" " rows="3"></textarea>
                         <label for="adDescription">Description</label>
                     </div>
                     <div class="form-field">
                         <input type="text" id="adContact" required placeholder=" ">
                         <label for="adContact">Contact Info</label>
                     </div>
                 </form>
            </div>
            <div class="modal-actions">
                <button type="button" class="uniform-btn" onclick="closeAddAdModal()">Cancel</button>
                <button type="submit" form="jobAdForm" class="uniform-btn">Post Ad</button>
            </div>
        </div>
      </div>
  </div>

  <!-- jsPDF Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // --- Firebase Configuration ---
    const firebaseConfig = {
      apiKey: "AIzaSyBTGsE2W_yYNC-baPkuwKlLe4rEaqtp2q8",
      authDomain: "duty--ad-maneger.firebaseapp.com",
      databaseURL: "https://duty--ad-maneger-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "duty--ad-maneger",
      storageBucket: "duty--ad-maneger.firebasestorage.app",
      messagingSenderId: "251018360246",
      appId: "1:251018360246:web:e3406805bbc7a54fcebd17",
      measurementId: "G-XW0ZJJR0TV"
    };
    // --- End Firebase Configuration ---

    // Initialize Firebase
    let app = null;
    let database = null;
    let jobAdsRef = null;
    let firebaseInitialized = false; // Flag to check if initialization was successful
    if (firebaseConfig.apiKey && firebaseConfig.databaseURL) {
        try {
            app = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            jobAdsRef = database.ref('jobAds');
            firebaseInitialized = true; // Set flag on success
            console.log("[Firebase] Initialized successfully.");
        } catch (e) {
            console.error("[Firebase] Initialization Error:", e);
            // alert("Firebase initialization failed. Please check the configuration and console.");
        }
    } else {
        console.warn("[Firebase] Configuration missing or invalid. Firebase features disabled.");
    }


    const { jsPDF } = (typeof window.jspdf !== 'undefined') ? window.jspdf : {};

    // --- Global State ---
    let isAppOnline = navigator.onLine; // Track connection status
    let currentActiveTabId = ''; // Track the currently active tab

    document.addEventListener("DOMContentLoaded", () => {
      // --- DOM Elements ---
      const viewDataTabButton = document.getElementById("viewDataTab");
      const jobAdsTabButton = document.querySelector('.tab-button[onclick*="job-ads"]'); // Get job ads tab button
      const allTabButtons = document.querySelectorAll('.tab-button');
      const fabButton = document.getElementById('fabButton');
      const summaryToggleBtn = document.getElementById("summaryToggleBtn");
      const downloadPdfBtn = document.getElementById("downloadPdfBtn");
      const deleteMonthBtn = document.getElementById("deleteMonthBtn");
      const tableBody = document.querySelector("#monthlyDataTable tbody");
      const summarySection = document.getElementById("summarySection");
      const editModal = document.getElementById("editDutyModal");
      const editDutyForm = document.getElementById("editDutyForm");
      const editDutyIdInput = document.getElementById("editDutyId");
      const editDateInput = document.getElementById("editDate");
      const editShiftSelect = document.getElementById("editShift");
      const editHoursInput = document.getElementById("editHours");
      const editOtHoursInput = document.getElementById("editOtHours");
      const monthSelector = document.getElementById("monthSelector");
      const summaryMonthLabel = document.getElementById("summaryMonthLabel");
      const addDutyScreen = document.getElementById('addDutyScreen');
      const rateForm = document.getElementById("rateForm");
      const dutyForm = document.getElementById("dutyForm");
      const regularRateInput = document.getElementById("regularRate");
      const otRateInput = document.getElementById("otRate");
      const dateInput = document.getElementById("date");
      const shiftSelect = document.getElementById("shift");
      const hoursInput = document.getElementById("hours");
      const otHoursInput = document.getElementById("otHours");
      const addJobAdModal = document.getElementById("addJobAdModal");
      const jobAdForm = document.getElementById("jobAdForm");
      const adTitleInput = document.getElementById("adTitle");
      const adDescriptionInput = document.getElementById("adDescription");
      const adContactInput = document.getElementById("adContact");
      const adCityInput = document.getElementById("adCity");
      const jobAdsListDiv = document.getElementById("jobAdsList");
      const citySearchInput = document.getElementById("citySearchInput");
      const postNewAdBtn = document.getElementById('postNewAdBtn');
      const viewDataContent = document.getElementById('view-data');
      const jobAdsContent = document.getElementById('job-ads');

      // Offline message content
      const OFFLINE_MESSAGE_HTML = `<div class="offline-message">⚠️ कोई इंटरनेट कनेक्शन नहीं। ऐप का उपयोग करने के लिए इंटरनेट कनेक्शन आवश्यक है। कृपया अपना कनेक्शन जांचें और पुनः प्रयास करें।</div>`;

      // --- Data Initialization ---
      const DEFAULT_RATES = { regularRate: 50.00, otRate: 75.00 };
      let rates = JSON.parse(localStorage.getItem("rates")) || { ...DEFAULT_RATES };
      let availableDutyMonths = JSON.parse(localStorage.getItem("dutyLog_availableMonths")) || [];
      let currentlySelectedMonth = '';
      let dutiesForSelectedMonth = [];
      const AD_LIFESPAN_MS = 72 * 60 * 60 * 1000;
      let jobAds = [];
      let adTimerInterval = null;
      let firebaseListenerAttached = false;

      // --- Utility Functions ---
      const getDutyLogKey = (month) => `dutyLog_${month}`;
      const getCurrentMonthYYYYMM = () => { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`; };
      function loadDutiesForMonth(month) { const key = getDutyLogKey(month); return JSON.parse(localStorage.getItem(key)) || []; }
      function saveDutiesForMonth(month, dutiesArray) { const key = getDutyLogKey(month); dutiesArray.sort((a, b) => new Date(a.date) - new Date(b.date)); localStorage.setItem(key, JSON.stringify(dutiesArray)); }
      function updateAvailableMonths(monthToAdd) { if (!availableDutyMonths.includes(monthToAdd)) { availableDutyMonths.push(monthToAdd); availableDutyMonths.sort().reverse(); localStorage.setItem("dutyLog_availableMonths", JSON.stringify(availableDutyMonths)); populateMonthSelector(); updateViewDataButtonState(); } }
      function removeMonthFromAvailable(monthToRemove) { availableDutyMonths = availableDutyMonths.filter(m => m !== monthToRemove); localStorage.setItem("dutyLog_availableMonths", JSON.stringify(availableDutyMonths)); populateMonthSelector(); updateViewDataButtonState(); }
      function populateMonthSelector() {
          monthSelector.innerHTML = '';
          if (!isAppOnline) {
              monthSelector.disabled = true;
              monthSelector.innerHTML = '<option value="">इंटरनेट नहीं है</option>';
              return;
          }

          if (availableDutyMonths.length === 0) {
              monthSelector.disabled = true; monthSelector.innerHTML = '<option value="">कोई डेटा नहीं</option>'; currentlySelectedMonth = '';
          } else {
              monthSelector.disabled = false;
              availableDutyMonths.forEach(month => {
                  const option = document.createElement('option'); option.value = month; const [year, monthNum] = month.split('-'); const date = new Date(year, monthNum - 1); option.textContent = date.toLocaleString('default', { month: 'long', year: 'numeric' }); monthSelector.appendChild(option);
              });
              if (availableDutyMonths.includes(currentlySelectedMonth)) { monthSelector.value = currentlySelectedMonth; } else if (availableDutyMonths.length > 0) { currentlySelectedMonth = availableDutyMonths[0]; monthSelector.value = currentlySelectedMonth; }
          }

          if (currentlySelectedMonth) { loadAndRenderSelectedMonth(); }
          else { renderMonthData(); } // Render empty state if online but no month
      }
      function loadAndRenderSelectedMonth() {
           if (!isAppOnline) { console.warn("[Offline] Preventing loadAndRenderSelectedMonth"); showOfflineMessage('view-data'); return; }
           currentlySelectedMonth = monthSelector.value;
           if (currentlySelectedMonth) { dutiesForSelectedMonth = loadDutiesForMonth(currentlySelectedMonth); renderMonthData(); } else { dutiesForSelectedMonth = []; renderMonthData(); }
      }
      function updateViewDataButtonState() {
           viewDataTabButton.disabled = !isAppOnline && availableDutyMonths.length === 0;
      }
      function escapeHTML(str) { if (!str) return ''; return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;'); }
      function formatTimeRemaining(ms) { if (ms <= 0) { return "Expired"; } const tS = Math.floor(ms/1000); const d=Math.floor(tS/(3600*24)); const h=Math.floor((tS%(3600*24))/3600); const m=Math.floor((tS%3600)/60); const s=tS%60; let p=[]; if(d>0)p.push(`${d}d`); if(h>0||d>0)p.push(`${String(h).padStart(2,'0')}h`); p.push(`${String(m).padStart(2,'0')}m`); p.push(`${String(s).padStart(2,'0')}s`); return p.join(' ')+" left"; }
      function updateAdTimers() { if(!isAppOnline) return; const now=Date.now(); const tE=jobAdsListDiv.querySelectorAll('.ad-timer[data-expires]'); tE.forEach(tEl=>{ const exp=parseInt(tEl.getAttribute('data-expires')); if(!isNaN(exp)){tEl.textContent=formatTimeRemaining(exp-now);}else{tEl.textContent="Error";} }); }
      function filterExpiredAdsLocally(adsArray) { const now = Date.now(); return adsArray.filter(ad => ad.expiresAt > now); }
      function startAdTimerInterval() { stopAdTimerInterval(); if(isAppOnline) { updateAdTimers(); adTimerInterval = setInterval(updateAdTimers, 1000); } }
      function stopAdTimerInterval() { if (adTimerInterval) { clearInterval(adTimerInterval); adTimerInterval = null; } }
      function resetForm(formElement) { /* ... (same as before) ... */
            formElement.reset();
            formElement.querySelectorAll('.form-field').forEach(field => {
                const input = field.querySelector('input:not([type="hidden"]), textarea, select');
                const label = field.querySelector('label');
                if (input && label) {
                    const isSelectEmpty = (input.tagName === 'SELECT' && !input.value);
                    const isInputEmpty = (input.tagName !== 'SELECT' && !input.value && input.placeholder === " ");
                    label.style.top = ''; label.style.fontSize = ''; label.style.color = ''; label.style.backgroundColor = 'transparent';
                    if (!isSelectEmpty && !isInputEmpty) {
                        label.style.top = '-2px'; label.style.fontSize = '0.75rem'; label.style.color = 'var(--primary-color)';
                        let bgColor = 'var(--surface-color)';
                        if (formElement.closest('.fullscreen-overlay')) { bgColor = 'var(--background-color)'; }
                        else if (formElement.closest('.modal')) { bgColor = 'var(--surface-color)'; }
                        else if (formElement.closest('#jobAdsHeader')) { bgColor = 'var(--background-color)'; }
                        label.style.backgroundColor = bgColor;
                    }
                }
            });
            if (formElement.id === 'rateForm') {
                regularRateInput.value = rates.regularRate.toFixed(2);
                otRateInput.value = rates.otRate.toFixed(2);
                setTimeout(() => { regularRateInput.dispatchEvent(new Event('input', { bubbles: true })); otRateInput.dispatchEvent(new Event('input', { bubbles: true })); }, 0);
            }
      }

      // --- Connection Handling ---
      function isOnline() {
          return navigator.onLine;
      }

      function showOfflineMessage(tabId) {
          const targetContent = document.getElementById(tabId);
          if (!targetContent) return;

          // Clear specific content areas first
          if (tabId === 'view-data') {
              tableBody.innerHTML = ''; // Clear table
              summarySection.style.display = 'none'; // Hide summary
              if (document.querySelector(`#${tabId} .offline-message`)) return; // Don't add if already present
              // Insert message before H3 or at the beginning
              const h3 = targetContent.querySelector('h3');
              if(h3) h3.insertAdjacentHTML('afterend', OFFLINE_MESSAGE_HTML);
              else targetContent.insertAdjacentHTML('afterbegin', OFFLINE_MESSAGE_HTML);
          } else if (tabId === 'job-ads') {
              jobAdsListDiv.innerHTML = OFFLINE_MESSAGE_HTML; // Replace list content
          } else {
               // Generic placement for other potential tabs
               if (!targetContent.querySelector('.offline-message')) {
                   targetContent.insertAdjacentHTML('afterbegin', OFFLINE_MESSAGE_HTML);
               }
          }

           // Stop Firebase related things if relevant tab
           if (tabId === 'job-ads') {
              stopAdTimerInterval();
              firebaseListenerAttached = false;
           }
      }

      function hideOfflineMessage(tabId) {
          const targetContent = document.getElementById(tabId);
          const offlineMsgElement = targetContent?.querySelector('.offline-message');
          if (offlineMsgElement) {
              offlineMsgElement.remove();
          }
          // Restore loading message if needed
          if (tabId === 'job-ads' && jobAdsListDiv.innerHTML.trim() === '') {
             jobAdsListDiv.innerHTML = '<p class="no-ads-message">Loading...</p>';
          } else if (tabId === 'view-data' && tableBody.innerHTML.trim() === '') {
             // We'll let renderMonthData handle the table content
          }
      }

      function handleConnectionChange() {
          isAppOnline = isOnline();
          console.log(`[Connection Change] Status changed to: ${isAppOnline ? 'Online' : 'Offline'}`);

          // --- UI Element Enable/Disable ---
          allTabButtons.forEach(btn => btn.disabled = !isAppOnline);
          fabButton.disabled = !isAppOnline;
          monthSelector.disabled = !isAppOnline; // Always disable month selector if offline
          citySearchInput.disabled = !isAppOnline;
          postNewAdBtn.disabled = !isAppOnline;

          // Buttons that depend on data AND connection
          const dutyDataExists = currentlySelectedMonth && dutiesForSelectedMonth.length > 0;
          summaryToggleBtn.disabled = !isAppOnline || !dutyDataExists;
          downloadPdfBtn.disabled = !isAppOnline || !dutyDataExists;
          deleteMonthBtn.disabled = !isAppOnline || !dutyDataExists;

          // --- Handle Content and Messages ---
          const activeContent = document.querySelector('.tab-content.active');
          const activeTabId = activeContent ? activeContent.id : null;

          if (isAppOnline) {
              console.log("[Connection Change] Came Online.");
              if (activeTabId) {
                  hideOfflineMessage(activeTabId);
                  console.log(`[Connection Change] Reloading data for active tab: ${activeTabId}`);
                  if (activeTabId === 'view-data') {
                      populateMonthSelector(); // This will re-render data
                  } else if (activeTabId === 'job-ads' && firebaseInitialized) {
                       listenForJobAds(); // Re-attach listener or load
                  }
              }
              // Restore month selector options if they exist
              if(activeTabId === 'view-data' || !activeTabId) { // Populate if view-data is active or no tab is active yet
                  populateMonthSelector();
              }

          } else {
              console.log("[Connection Change] Went Offline.");
              stopAdTimerInterval(); // Stop timers
              firebaseListenerAttached = false; // Detach listener logically
              if (activeTabId) {
                  showOfflineMessage(activeTabId);
              }
              // Disable month selector and show offline message
              monthSelector.disabled = true;
              monthSelector.innerHTML = '<option value="">इंटरनेट नहीं है</option>';

              // Clear specific content areas in non-active tabs too for safety
              if (activeTabId !== 'view-data') {
                  tableBody.innerHTML = '';
                  summarySection.style.display = 'none';
              }
               if (activeTabId !== 'job-ads') {
                  jobAdsListDiv.innerHTML = '';
              }
              // Close modals
              if (editModal.style.display === 'block') closeEditModal();
              if (addJobAdModal.style.display === 'block') closeAddAdModal();
              if (addDutyScreen.style.display === 'flex') closeAddDutyScreen();
          }
           updateViewDataButtonState(); // Ensure View Duty tab state is correct
      }

      // --- Firebase Job Ad Listener ---
      function listenForJobAds() {
           if (!isAppOnline) { console.warn("[Offline] Preventing Firebase listener attachment."); showOfflineMessage('job-ads'); return; }
           if (!firebaseInitialized) { console.warn("[Firebase] Not initialized."); jobAdsListDiv.innerHTML = '<p class="no-ads-message" style="color: var(--error-color);">Firebase शुरू नहीं हुआ।</p>'; return; }
           if (firebaseListenerAttached) { console.log("[Firebase] Listener already attached."); renderJobAds(); return; }

           firebaseListenerAttached = true;
           console.log("[Firebase] Attaching job ads listener...");
           hideOfflineMessage('job-ads');
           jobAdsListDiv.innerHTML = '<p class="no-ads-message">Loading ads...</p>';

           jobAdsRef.on('value', (snapshot) => {
                if (!isAppOnline) { console.warn("[Offline] Received Firebase update while offline, ignoring."); return; }
                console.log("[Firebase] Received data update.");
                const adsData = snapshot.val(); const adsList = [];
                if (adsData) {
                     for (const key in adsData) {
                          if (adsData[key]?.createdAt && adsData[key]?.expiresAt) { adsList.push({ id: key, ...adsData[key] }); }
                          else { console.warn(`[Firebase] Skipping invalid ad data for key: ${key}`, adsData[key]); }
                     }
                }
                jobAds = adsList;
                console.log("[Firebase] Processed job ads:", jobAds.length);
                renderJobAds();
           }, (error) => {
                console.error("[Firebase] Error fetching job ads:", error);
                let errorMsg = `जॉब विज्ञापन लोड करने में त्रुटि: ${error.message}`;
                if (!isOnline()) { errorMsg = "⚠️ कोई इंटरनेट कनेक्शन नहीं। विज्ञापन लोड नहीं किए जा सके।"; }
                else if (error.code === 'NETWORK_ERROR' || error.message.toLowerCase().includes('network')) { errorMsg = "⚠️ नेटवर्क त्रुटि।"; }
                else if (error.code === 'PERMISSION_DENIED') { errorMsg = "⛔ अनुमति अस्वीकृत।"; }
                jobAdsListDiv.innerHTML = `<p class="no-ads-message" style="color: var(--error-color);">${escapeHTML(errorMsg)}</p>`;
                firebaseListenerAttached = false;
           });
      }

      // --- Event Handlers ---
      rateForm.addEventListener("submit", (e) => { e.preventDefault(); if (!isAppOnline) { alert("⚠️ ऑफलाइन। दरें सहेजी नहीं जा सकतीं।"); return; } const nRR=parseFloat(regularRateInput.value); const nOR=parseFloat(otRateInput.value); if(isNaN(nRR)||isNaN(nOR)||nRR<0||nOR<0){alert("अमान्य दरें।"); return;} rates.regularRate=nRR; rates.otRate=nOR; localStorage.setItem("rates",JSON.stringify(rates)); alert("दरें सहेजी गईं!"); if(currentlySelectedMonth) renderMonthData(); });
      dutyForm.addEventListener("submit", (e) => { e.preventDefault(); if (!isAppOnline) { alert("⚠️ ऑफलाइन। ड्यूटी नहीं जोड़ी जा सकती।"); return; } const date=dateInput.value; const shift=shiftSelect.value; const hours=parseFloat(hoursInput.value)||0; const otHours=parseFloat(otHoursInput.value)||0; if(!date||!shift){alert("तारीख और शिफ्ट आवश्यक है।"); return;} if(hours<0||otHours<0){alert("घंटे नकारात्मक नहीं हो सकते।"); return;} if(shift!=="Off Day"&&hours<=0&&otHours<=0){alert("घंटे दर्ज करें।"); return;} if(shift==="Off Day"&&(hours>0||otHours>0)){if(!confirm("छुट्टी वाले दिन घंटे दर्ज हैं? ठीक है?")){return;}} const entryMonth=date.slice(0,7); const currentActualMonth=getCurrentMonthYYYYMM(); if(entryMonth<currentActualMonth){const entryDate=new Date(date+'T00:00:00'); const monthName=entryDate.toLocaleString('default',{month:'long',year:'numeric'}); if(!confirm(`⚠️ ${monthName} के लिए ड्यूटी जोड़ी जा रही है। आगे बढ़ें?`)){return;}} updateAvailableMonths(entryMonth); let dutiesForMonth=loadDutiesForMonth(entryMonth); const newDuty={id:Date.now(),date,shift,hours,otHours}; dutiesForMonth.push(newDuty); saveDutiesForMonth(entryMonth,dutiesForMonth); resetForm(dutyForm); alert("ड्यूटी जोड़ी गई!"); currentlySelectedMonth=entryMonth; populateMonthSelector(); closeAddDutyScreen(); switchTab('view-data'); });
      tableBody.addEventListener('click', function(e){ const btn=e.target.closest('.edit-btn'); if(btn){ if (!isAppOnline) { alert("⚠️ ऑफलाइन। संपादन संभव नहीं।"); return; } const id=parseInt(btn.getAttribute('data-id')); openEditModal(id); } });
      editDutyForm.addEventListener('submit', function(e){ e.preventDefault(); if (!isAppOnline) { alert("⚠️ ऑफलाइन। बदलाव सहेजे नहीं जा सकते।"); return; } const dutyId=parseInt(editDutyIdInput.value); const newDate=editDateInput.value; const newShift=editShiftSelect.value; const newHours=parseFloat(editHoursInput.value)||0; const newOtHours=parseFloat(editOtHoursInput.value)||0; if(!newDate||!newShift){alert("तारीख और शिफ्ट आवश्यक है।"); return;} if(newHours<0||newOtHours<0){alert("घंटे नकारात्मक नहीं हो सकते।"); return;} if(newShift!=="Off Day"&&newHours<=0&&newOtHours<=0){alert("घंटे दर्ज करें।"); return;} const targetMonth=newDate.slice(0,7); let dutiesToUpdate=loadDutiesForMonth(currentlySelectedMonth); const dutyIndex=dutiesToUpdate.findIndex(duty=>duty.id===dutyId); if(dutyIndex>-1){const originalDate=dutiesToUpdate[dutyIndex].date; const originalMonth=originalDate.slice(0,7); if(originalMonth!==targetMonth){const targetDateObj=new Date(newDate+'T00:00:00'); const targetMonthName=targetDateObj.toLocaleString('default',{month:'long',year:'numeric'}); if(!confirm(`⚠️ ड्यूटी को ${targetMonthName} में ले जाया जा रहा है। आगे बढ़ें?`)){return;} let oldMonthDuties=dutiesToUpdate; oldMonthDuties=oldMonthDuties.filter(d=>d.id!==dutyId); saveDutiesForMonth(originalMonth,oldMonthDuties); if(oldMonthDuties.length===0){removeMonthFromAvailable(originalMonth);} const updatedDuty={id:dutyId,date:newDate,shift:newShift,hours:newHours,otHours:newOtHours}; updateAvailableMonths(targetMonth); let newMonthDuties=loadDutiesForMonth(targetMonth); newMonthDuties.push(updatedDuty); saveDutiesForMonth(targetMonth,newMonthDuties); currentlySelectedMonth=targetMonth;}else{dutiesToUpdate[dutyIndex]={...dutiesToUpdate[dutyIndex],date:newDate,shift:newShift,hours:newHours,otHours:newOtHours}; saveDutiesForMonth(targetMonth,dutiesToUpdate);} populateMonthSelector(); closeEditModal(); alert("ड्यूटी अपडेट की गई!");}else{alert("ड्यूटी अपडेट करने में त्रुटि।");} });
      monthSelector.addEventListener('change', loadAndRenderSelectedMonth);
      jobAdForm.addEventListener("submit", (e) => {
          e.preventDefault();
          if (!isAppOnline) { alert("⚠️ ऑफलाइन। विज्ञापन पोस्ट नहीं किया जा सकता।"); return; }
          if (!firebaseInitialized || !jobAdsRef) { alert("Firebase कॉन्फ़िगर नहीं है। विज्ञापन पोस्ट नहीं किया जा सकता।"); return; }
          const title = adTitleInput.value.trim(); const city = adCityInput.value.trim(); const description = adDescriptionInput.value.trim(); const contact = adContactInput.value.trim();
          if (!title || !city || !description || !contact) { alert("कृपया सभी फ़ील्ड भरें।"); return; }
          const now = Date.now(); const newAdData = { title: title, city: city, description: description, contact: contact, createdAt: now, expiresAt: now + AD_LIFESPAN_MS };
          const submitButton = jobAdForm.querySelector('button[type="submit"]'); if(submitButton) submitButton.disabled = true;
          jobAdsRef.push(newAdData)
              .then(() => { alert("जॉब विज्ञापन पोस्ट किया गया!"); closeAddAdModal(); })
              .catch((error) => { let msg = "विज्ञापन पोस्ट करने में विफल।"; if (!isOnline()){ msg = "⚠️ ऑफलाइन।"; } else if (error.code === 'PERMISSION_DENIED') { msg = "⛔ अनुमति नहीं।"; } else { msg += `\nत्रुटि: ${error.message}`; } alert(msg); })
              .finally(() => { if(submitButton) submitButton.disabled = false; });
          resetForm(jobAdForm);
      });
      citySearchInput.addEventListener('input', () => { if(isAppOnline) renderJobAds(); }); // Only render if online

      // --- Core Functions ---
      function renderMonthData() {
           if (!isAppOnline) { showOfflineMessage('view-data'); return; }
           hideOfflineMessage('view-data');
           tableBody.innerHTML = ""; summarySection.style.display = "none"; const sSpan = summaryToggleBtn.querySelector('span'); if(sSpan) sSpan.textContent = 'Summary';
           const enableButtons = currentlySelectedMonth && dutiesForSelectedMonth.length > 0;
           summaryToggleBtn.disabled = !enableButtons; downloadPdfBtn.disabled = !enableButtons; deleteMonthBtn.disabled = !enableButtons;
           const mLblTxt = monthSelector.options[monthSelector.selectedIndex]?.textContent || 'the selected month';
           if (!currentlySelectedMonth || dutiesForSelectedMonth.length === 0) { tableBody.innerHTML = `<tr class="no-data-message"><td colspan="5">${escapeHTML(mLblTxt)} के लिए कोई डेटा नहीं। ${isAppOnline ? '+ बटन का उपयोग करके जोड़ें।' : ''}</td></tr>`; resetSummaryFigures(); summaryMonthLabel.textContent = ''; return; }
           let tRP=0,tOP=0,tHW=0,tOH=0;
           dutiesForSelectedMonth.forEach((d,i)=>{const rP=d.hours*rates.regularRate; const oP=d.otHours*rates.otRate; tRP+=rP; tOP+=oP; tHW+=d.hours; tOH+=d.otHours; const r=tableBody.insertRow(); r.style.animationDelay=`${i*0.05}s`; if(d.shift==="Off Day"){r.classList.add("shutty-row");} const otCls=d.otHours>0?"blue-text":""; r.innerHTML=`<td>${d.date}</td><td>${d.shift}</td><td>${d.hours.toFixed(2)}</td><td class="${otCls}">${d.otHours.toFixed(2)}</td><td><button class="uniform-btn edit-btn" data-id="${d.id}" ${!isAppOnline ? 'disabled' : ''}><i class="material-icons" style="font-size:1rem;vertical-align:middle;">edit</i> Edit</button></td>`; });
           summaryMonthLabel.textContent=mLblTxt; document.getElementById("totalHoursWorked").textContent=`${tHW.toFixed(2)} hrs`; document.getElementById("totalOTHrs").textContent=`${tOH.toFixed(2)} hrs`; document.getElementById("summaryRegularRate").textContent=`₹${rates.regularRate.toFixed(2)}/hr`; document.getElementById("summaryOtRate").textContent=`₹${rates.otRate.toFixed(2)}/hr`; document.getElementById("totalRegularPayment").textContent=`₹${tRP.toFixed(2)}`; document.getElementById("totalOTPayment").textContent=`₹${tOP.toFixed(2)}`; document.getElementById("totalPayment").textContent=`₹${(tRP+tOP).toFixed(2)}`;
      }
      function resetSummaryFigures() { /* ... (unchanged) ... */ document.getElementById("totalHoursWorked").textContent=`0.00 hrs`; document.getElementById("totalOTHrs").textContent=`0.00 hrs`; document.getElementById("summaryRegularRate").textContent=`₹${rates.regularRate.toFixed(2)}/hr`; document.getElementById("summaryOtRate").textContent=`₹${rates.otRate.toFixed(2)}/hr`; document.getElementById("totalRegularPayment").textContent=`₹0.00`; document.getElementById("totalOTPayment").textContent=`₹0.00`; document.getElementById("totalPayment").textContent=`₹0.00`; }
      function renderJobAds() {
          if (!isAppOnline) { showOfflineMessage('job-ads'); return; }
          hideOfflineMessage('job-ads');
          const currentAds = Array.isArray(jobAds) ? jobAds : []; const activeAds = filterExpiredAdsLocally(currentAds);
          jobAdsListDiv.innerHTML = ""; const searchTerm = citySearchInput.value.trim().toLowerCase();
          const filteredAdsToDisplay = activeAds.filter(ad => { const cityLower = typeof ad.city === 'string' ? ad.city.toLowerCase() : ''; return searchTerm === '' || cityLower.includes(searchTerm); });
          if (filteredAdsToDisplay.length === 0) {
              let msg = '<p class="no-ads-message">कोई जॉब विज्ञापन उपलब्ध नहीं।</p>';
              if (activeAds.length > 0 && searchTerm !== '') { msg = `<p class="no-ads-message">"${escapeHTML(citySearchInput.value)}" से मेल खाने वाला कोई विज्ञापन नहीं।</p>`; }
              else if (currentAds.length > 0 && activeAds.length === 0) { msg = '<p class="no-ads-message">कोई सक्रिय विज्ञापन नहीं हैं।</p>'; }
              else if (!firebaseInitialized) { msg = '<p class="no-ads-message" style="color: var(--error-color);">Firebase शुरू नहीं हुआ।</p>'; }
              jobAdsListDiv.innerHTML = msg; stopAdTimerInterval();
          } else {
              [...filteredAdsToDisplay].sort((a, b) => b.createdAt - a.createdAt).forEach((ad, index) => { const adCard = document.createElement('div'); adCard.className = 'job-ad-card'; adCard.style.animationDelay = `${index * 0.07}s`; adCard.innerHTML = `<div class="ad-header"><h4>${escapeHTML(ad.title)}</h4><span class="ad-city"><i class="material-icons">location_city</i>${escapeHTML(ad.city)}</span></div><p class="ad-description">${escapeHTML(ad.description)}</p><p class="ad-contact"><i class="material-icons">contact_phone</i>${escapeHTML(ad.contact)}</p><div class="ad-timer" data-expires="${ad.expiresAt}">Calculating...</div>`; jobAdsListDiv.appendChild(adCard); });
              startAdTimerInterval();
          }
      }

      // --- Global Functions ---
      window.toggleSummary = function () { if (!isAppOnline || !currentlySelectedMonth || dutiesForSelectedMonth.length===0) return; const isHidden=summarySection.style.display==="none"||summarySection.style.display===""; summarySection.style.display=isHidden?"flex":"none"; const sSpan = summaryToggleBtn.querySelector('span'); if(sSpan) sSpan.textContent = isHidden?'Hide Summary':'Show Summary'; };
      window.deleteCurrentMonthData = function () { if (!isAppOnline) { alert("⚠️ ऑफलाइन। डेटा नहीं हटाया जा सकता।"); return; } if(!currentlySelectedMonth){alert("महीना चुनें।"); return;} const monthLabel=monthSelector.options[monthSelector.selectedIndex]?.textContent||currentlySelectedMonth; if(confirm(`⚠️ ${monthLabel} का डेटा हटाएं?`)){localStorage.removeItem(getDutyLogKey(currentlySelectedMonth)); removeMonthFromAvailable(currentlySelectedMonth); alert(`${monthLabel} का डेटा हटा दिया गया!`); currentlySelectedMonth = availableDutyMonths.length > 0 ? availableDutyMonths[0] : ''; populateMonthSelector();} };
      window.downloadMonthPDF = function () { if (!isAppOnline) { alert("⚠️ ऑफलाइन। PDF डाउनलोड नहीं किया जा सकता।"); return; } /* ... (rest of PDF function remains same) ... */ if(!currentlySelectedMonth||dutiesForSelectedMonth.length===0){alert("डेटा नहीं है।");return;}try{if(!window.jspdf?.jsPDF){alert("jsPDF लाइब्रेरी नहीं मिली।");return;}const{jsPDF}=window.jspdf;if(!jsPDF.API?.autoTable){alert("jsPDF AutoTable प्लगइन नहीं मिला।");return;}const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});const monthLabel=monthSelector.options[monthSelector.selectedIndex]?.textContent||currentlySelectedMonth;const tableData=dutiesForSelectedMonth.map(d=>[d.date||'',d.shift||'',(d.hours||0).toFixed(2),(d.otHours||0).toFixed(2)]);const getElTxt=(id)=>document.getElementById(id)?.textContent||'N/A';const sL=[`${monthLabel} सारांश:`,`------------------------------------`,`कुल घंटे: ${getElTxt("totalHoursWorked")}`,`कुल OT घंटे: ${getElTxt("totalOTHrs")}`,`नियमित दर: ${getElTxt("summaryRegularRate")}`,`OT दर: ${getElTxt("summaryOtRate")}`,`------------------------------------`,`नियमित भुगतान: ${getElTxt("totalRegularPayment")}`,`OT भुगतान: ${getElTxt("totalOTPayment")}`,`------------------------------------`,`कुल योग: ${getElTxt("totalPayment")}`];doc.setFontSize(18);doc.setTextColor(40);doc.text(`ड्यूटी रिपोर्ट - ${monthLabel}`,14,22);doc.autoTable({head:[['Date','Shift','Hours','OT']],body:tableData,startY:30,theme:'grid',headStyles:{fillColor:[63,81,181],textColor:255,fontStyle:'bold'},styles:{fontSize:9.5,cellPadding:2.5,overflow:'linebreak'},columnStyles:{0:{cellWidth:25},1:{cellWidth:30},2:{halign:'right',cellWidth:20},3:{halign:'right',cellWidth:20}},didParseCell:function(data){try{if(data.column.index===3&&parseFloat(data.cell.raw)>0){data.cell.styles.textColor=[63,81,181];data.cell.styles.fontStyle='bold';}if(data.column.index===1&&data.cell.raw==='Off Day'){Object.values(data.row.cells).forEach(c=>{c.styles.fillColor=[255,235,238];c.styles.textColor=[211,47,47];c.styles.fontStyle='bold';});}}catch(e){}}});let fY=doc.lastAutoTable.finalY||30;fY+=10;const pH=doc.internal.pageSize.height||doc.internal.pageSize.getHeight();const sH=sL.length*5;if(fY+sH>pH-20){doc.addPage();fY=20;}doc.setFontSize(11);doc.setTextColor(50);doc.text(sL,14,fY);const pW=doc.internal.pageSize.width||doc.internal.pageSize.getWidth();const pC=doc.internal.getNumberOfPages();for(let i=1;i<=pC;i++){doc.setPage(i);doc.setFontSize(9);doc.setTextColor(150);doc.text(`Generated: ${new Date().toLocaleString()}`,14,pH-10);doc.text(`Page ${i} of ${pC}`,pW/2,pH-10,{align:'center'});doc.text("Duty & Ad Mgr",pW-14,pH-10,{align:'right'});}doc.save(`DutyReport_${currentlySelectedMonth}.pdf`);}catch(err){console.error("[PDF ERR]",err);alert("PDF बनाने में विफल।\nत्रुटि: "+err.message);} };
      window.switchTab = function (tabId) {
          if (addDutyScreen.style.display === 'flex') { closeAddDutyScreen(); }
          currentActiveTabId = tabId;
          document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));
          const tabContent = document.getElementById(tabId);
          if (tabContent) tabContent.classList.add("active");
          document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
          const activeButton = document.querySelector(`.tab-button[onclick="switchTab('${tabId}')"]`);
          if (activeButton) { activeButton.classList.add("active"); }

          if (!isAppOnline) {
              console.warn(`[Offline] Switched to tab ${tabId} while offline.`);
              showOfflineMessage(tabId); stopAdTimerInterval();
          } else {
              console.log(`[Online] Switched to tab ${tabId}.`); hideOfflineMessage(tabId);
              if (tabId === 'view-data') { loadAndRenderSelectedMonth(); stopAdTimerInterval(); }
              else if (tabId === 'job-ads' && firebaseInitialized) { listenForJobAds(); }
              else { stopAdTimerInterval(); }
          }
      };
      window.openEditModal = function (dutyId) { if (!isAppOnline) { alert("⚠️ ऑफलाइन।"); return; } const dte=dutiesForSelectedMonth.find(d=>d.id===dutyId); if(dte){editDutyIdInput.value=dte.id; editDateInput.value=dte.date; editShiftSelect.value=dte.shift; editHoursInput.value=dte.hours; editOtHoursInput.value=dte.otHours; editModal.style.display="block"; setTimeout(() => {editDateInput.dispatchEvent(new Event('input',{bubbles:true})); editShiftSelect.dispatchEvent(new Event('change',{bubbles:true})); editHoursInput.dispatchEvent(new Event('input',{bubbles:true})); editOtHoursInput.dispatchEvent(new Event('input',{bubbles:true})); },0);}else{alert("Duty not found.");}};
      window.closeEditModal = function () { editModal.style.display="none"; resetForm(editDutyForm); };
      window.openAddAdModal = function () { if (!isAppOnline) { alert("⚠️ ऑफलाइन।"); return; } addJobAdModal.style.display="block"; resetForm(jobAdForm); adTitleInput.focus(); };
      window.closeAddAdModal = function () { addJobAdModal.style.display="none"; resetForm(jobAdForm); };
      window.openAddDutyScreen = function() { if (!isAppOnline) { alert("⚠️ ऑफलाइन।"); return; } resetForm(rateForm); resetForm(dutyForm); addDutyScreen.style.display='flex'; dateInput.focus(); }
      window.closeAddDutyScreen = function() { addDutyScreen.style.display='none'; }
      window.onclick = function (event) { if(event.target==editModal){closeEditModal();} if(event.target==addJobAdModal){closeAddAdModal();} };

      // --- Initial Setup ---
      console.log("[Init] Starting application setup...");
      isAppOnline = isOnline();
      console.log(`[Init] Initial connection status: ${isAppOnline ? 'Online' : 'Offline'}`);
      window.addEventListener('online', handleConnectionChange);
      window.addEventListener('offline', handleConnectionChange);
      regularRateInput.value = rates.regularRate.toFixed(2); otRateInput.value = rates.otRate.toFixed(2);
      setTimeout(() => { regularRateInput.dispatchEvent(new Event('input',{bubbles:true})); otRateInput.dispatchEvent(new Event('input',{bubbles:true})); }, 0);

      handleConnectionChange(); // Set initial UI state

      if (isAppOnline) {
           populateMonthSelector(); updateViewDataButtonState();
           const defaultTab = availableDutyMonths.length > 0 ? 'view-data' : (firebaseInitialized ? 'job-ads' : 'view-data');
           console.log(`[Init] Online. Defaulting to ${defaultTab}`);
           switchTab(defaultTab);
      } else {
           updateViewDataButtonState();
           const defaultTab = availableDutyMonths.length > 0 ? 'view-data' : 'job-ads';
           switchTab(defaultTab); // Will show offline message
           console.log("[Init] App loaded Offline.");
      }
      console.log("[Init] Application setup complete.");

      // --- PWA Service Worker Registration ---
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js') // Path relative to origin
            .then(registration => {
              console.log('ServiceWorker registration successful with scope: ', registration.scope);
            })
            .catch(err => {
              console.log('ServiceWorker registration failed: ', err);
            });
        });
      }
      // --- End PWA Service Worker Registration ---

    });
  </script>
<script type='text/javascript' src='//pl25987362.effectiveratecpm.com/57/0b/44/570b445b34d7dda4fc78cffc1f0742c8.js'></script>
	
</body>
</html>
